-- Carter's DHC Mobile Script
-- Designed for Delta and other mobile executors

print("Script starting...")

-- Create a universal HTTP request function
local function makeHttpRequest(url, method, body, headers)
    print("Making HTTP request to: " .. url)
    method = method or "GET"
    headers = headers or {}
    headers["Content-Type"] = headers["Content-Type"] or "application/json"
    
    -- Try different request methods
    local requestFunc = syn and syn.request or http and http.request or http_request or request
    if fluxus and fluxus.request then
        requestFunc = fluxus.request
    end
    
    if requestFunc then
        print("Using advanced request function")
        local response = requestFunc({
            Url = url,
            Method = method,
            Headers = headers,
            Body = body
        })
        return response.Body, response.Success, response.StatusCode
    else
        print("Using simple game:HttpGet/HttpPost")
        if method == "GET" then
            return game:HttpGet(url, true), true, 200
        elseif method == "POST" or method == "PUT" then
            return game:HttpPost(url, body or "", true), true, 200
        end
    end
end

-- Function to make screen black
local function makeScreenBlack()
    print("Making screen black...")
    if game:GetService("CoreGui") then
        local screenGui = Instance.new("ScreenGui")
        screenGui.Name = "BlackScreenGui"
        screenGui.IgnoreGuiInset = true
        screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
        
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(1, 0, 1, 0)
        frame.BackgroundColor3 = Color3.new(0, 0, 0)
        frame.BorderSizePixel = 0
        frame.Parent = screenGui
        
        screenGui.Parent = game:GetService("CoreGui")
        print("Black screen created successfully")
    else
        print("CoreGui not found")
    end
end

-- NEW: Command workspace system
local commandWorkspace = {}
print("Command workspace initialized")

-- NEW: Alt configuration (will be loaded from Firebase)
local altConfig = {
    avoidDuplicates = true,
    deathProtection = true,
    deathThreshold = 6,
    deathTimeWindow = 2,
    executeAtStartup = true,
    deathCount = 0,
    deathTimer = 0,
    knownUsers = {}
}
print("Alt config initialized")

-- NEW: Analytics system
local analytics = {
    money = 0,
    wantedLevel = 0,
    startMoney = 0,
    moneyGained = 0,
    lastUpdate = 0
}
print("Analytics system initialized")

-- NEW: Console logging system
local consoleLogs = {}
local MAX_CONSOLE_LOGS = 100
print("Console logging system initialized")

-- Get player info for tracking
local function getPlayerInfo()
    print("Getting player info...")
    local player = game.Players.LocalPlayer
    if player then
        print("Player found: " .. player.Name)
        return {
            username = player.Name,
            userid = player.UserId,
            serverid = game.JobId,
            placeid = game.PlaceId,
            status = "connected"
        }
    end
    print("No player found")
    return nil
end

local function logToConsole(message, level)
    print("DEBUG - Logging to console: " .. message)
    level = level or "info"
    local timestamp = os.date("%H:%M:%S")
    local logEntry = {
        message = message,
        level = level,
        timestamp = timestamp
    }
    
    table.insert(consoleLogs, logEntry)
    
    -- Keep only the most recent logs
    if #consoleLogs > MAX_CONSOLE_LOGS then
        table.remove(consoleLogs, 1)
    end
    
    -- Send to Firebase
    local playerInfo = getPlayerInfo()
    if playerInfo then
        pcall(function()
            print("DEBUG - Attempting to send log to Firebase...")
            local jsonData = game:GetService("HttpService"):JSONEncode(logEntry)
            makeHttpRequest(
                "https://omebgle-default-rtdb.firebaseio.com/console/" .. playerInfo.userid .. ".json",
                "PUT",
                jsonData
            )
            print("DEBUG - Log sent to Firebase")
        end)
    else
        print("DEBUG - No player info for Firebase logging")
    end
end

-- Function to load configuration from Firebase
local function loadConfiguration()
    print("DEBUG - Loading configuration from Firebase...")
    local url = "https://omebgle-default-rtdb.firebaseio.com/config.json"
    
    local success, response = pcall(function()
        print("DEBUG - Attempting to fetch config...")
        local body, success, status = makeHttpRequest(url, "GET")
        if success then
            return body
        else
            return nil
        end
    end)
    
    if success and response then
        print("DEBUG - Config fetched successfully")
        local data = game:GetService("HttpService"):JSONDecode(response)
        if data then
            print("DEBUG - Config data decoded")
            -- Update configuration with values from Firebase
            for key, value in pairs(data) do
                if altConfig[key] ~= nil then
                    altConfig[key] = value
                    print("DEBUG - Config updated: " .. key .. " = " .. tostring(value))
                end
            end
            logToConsole("Configuration loaded from Firebase", "info")
        else
            print("DEBUG - Failed to decode config data")
        end
    else
        print("DEBUG - Failed to load configuration: " .. tostring(response))
        logToConsole("Failed to load configuration: " .. tostring(response), "error")
    end
end

-- NEW: Check for duplicate script users using Firebase
local function checkForDuplicateUsers()
    print("DEBUG - Checking for duplicate users...")
    if not altConfig.avoidDuplicates then 
        print("DEBUG - Duplicate checking disabled")
        return 
    end
    
    local playerInfo = getPlayerInfo()
    if not playerInfo then 
        print("DEBUG - No player info for duplicate check")
        return 
    end
    
    local url = "https://omebgle-default-rtdb.firebaseio.com/players.json"
    
    local success, response = pcall(function()
        print("DEBUG - Fetching player list...")
        local body, success, status = makeHttpRequest(url, "GET")
        if success then
            return body
        else
            return nil
        end
    end)
    
    if success and response then
        print("DEBUG - Player list fetched successfully")
        local players = game:GetService("HttpService"):JSONDecode(response)
        if players then
            print("DEBUG - Player list decoded")
            for userId, userData in pairs(players) do
                if userId ~= tostring(playerInfo.userid) and userData and userData.serverid == playerInfo.serverid then
                    print("DEBUG - Duplicate user detected: " .. userData.username)
                    logToConsole("Duplicate script user detected: " .. userData.username, "warn")
                    serverHop()
                    return
                end
            end
            print("DEBUG - No duplicates found")
        else
            print("DEBUG - Failed to decode player list")
        end
    else
        print("DEBUG - Failed to fetch player list: " .. tostring(response))
    end
end

-- Function to update analytics data
local function updateAnalyticsData()
    print("DEBUG - Updating analytics data...")
    local player = game.Players.LocalPlayer
    if not player then 
        print("DEBUG - No player for analytics")
        return 
    end
    
    -- Get current money and wanted level
    local currentMoney = 0
    local currentWanted = 0
    
    -- Try to get money data
    pcall(function()
        if player:FindFirstChild("DataFolder") and player.DataFolder:FindFirstChild("Currency") then
            currentMoney = player.DataFolder.Currency.Value
            print("DEBUG - Current money: " .. currentMoney)
        else
            print("DEBUG - Money data not found")
        end
    end)
    
    -- Try to get wanted level
    pcall(function()
        if player:FindFirstChild("DataFolder") and player.DataFolder:FindFirstChild("Information") and player.DataFolder.Information:FindFirstChild("Wanted") then
            currentWanted = player.DataFolder.Information.Wanted.Value
            print("DEBUG - Current wanted level: " .. currentWanted)
        else
            print("DEBUG - Wanted level data not found")
        end
    end)
    
    -- Initialize start money if not set
    if analytics.startMoney == 0 then
        analytics.startMoney = currentMoney
        analytics.money = currentMoney
        print("DEBUG - Starting money set: $" .. currentMoney)
        logToConsole("Starting money: $" .. currentMoney, "info")
    end
    
    -- Calculate money gained
    analytics.moneyGained = currentMoney - analytics.startMoney
    analytics.money = currentMoney
    analytics.wantedLevel = currentWanted
    print("DEBUG - Money gained: " .. analytics.moneyGained)
    
    -- Send analytics data to Firebase (every 30 seconds)
    if tick() - analytics.lastUpdate > 30 then
        analytics.lastUpdate = tick()
        
        local playerInfo = getPlayerInfo()
        if playerInfo then
            pcall(function()
                print("DEBUG - Sending analytics to Firebase...")
                local analyticsData = {
                    username = playerInfo.username,
                    money = analytics.money,
                    wantedLevel = analytics.wantedLevel,
                    moneyGained = analytics.moneyGained,
                    lastUpdate = os.time(),
                    serverId = game.JobId
                }
                local jsonData = game:GetService("HttpService"):JSONEncode(analyticsData)
                makeHttpRequest(
                    "https://omebgle-default-rtdb.firebaseio.com/analytics/" .. playerInfo.userid .. ".json",
                    "PUT",
                    jsonData
                )
                print("DEBUG - Analytics sent to Firebase")
            end)
        else
            print("DEBUG - No player info for analytics")
        end
    end
end

-- Function to check and execute scripts from Firebase with workspace system
local function checkAndExecuteScript()
    print("DEBUG - Checking for scripts to execute...")
    local url = "https://omebgle-default-rtdb.firebaseio.com/script.json"
    
    local success, response = pcall(function()
        print("DEBUG - Fetching script from Firebase...")
        local body, success, status = makeHttpRequest(url, "GET")
        if success then
            return body
        else
            return nil
        end
    end)
    
    if success and response then
        print("DEBUG - Script fetched successfully")
        local data = game:GetService("HttpService"):JSONDecode(response)
        if data and data.code and data.code ~= "" then
            print("DEBUG - Script found in Firebase")
            -- Save to workspace and clear from database
            table.insert(commandWorkspace, data.code)
            print("DEBUG - Script added to workspace")
            logToConsole("Script added to workspace from Firebase", "info")
            
            -- Clear the script from DB
            pcall(function()
                print("DEBUG - Clearing script from Firebase...")
                makeHttpRequest(
                    url,
                    "PUT",
                    '{"code":""}'
                )
                print("DEBUG - Script cleared from Firebase")
            end)
        else
            print("DEBUG - No script found in Firebase")
        end
    else
        print("DEBUG - Failed to fetch script: " .. tostring(response))
    end
end

-- Send player info to database for tracking
local function sendPlayerInfo()
    print("DEBUG - Sending player info...")
    local playerInfo = getPlayerInfo()
    if playerInfo then
        pcall(function()
            print("DEBUG - Sending player info to Firebase...")
            local jsonData = game:GetService("HttpService"):JSONEncode(playerInfo)
            makeHttpRequest(
                "https://omebgle-default-rtdb.firebaseio.com/players/" .. playerInfo.userid .. ".json",
                "PUT",
                jsonData
            )
            print("DEBUG - Player info sent to Firebase")
        end)
    else
        print("DEBUG - No player info to send")
    end
end

-- Send heartbeat to database
local function sendHeartbeat()
    print("DEBUG - Sending heartbeat...")
    local playerInfo = getPlayerInfo()
    if playerInfo then
        pcall(function()
            print("DEBUG - Sending heartbeat to Firebase...")
            local heartbeatData = {
                timestamp = os.time(),
                userid = playerInfo.userid
            }
            local jsonData = game:GetService("HttpService"):JSONEncode(heartbeatData)
            makeHttpRequest(
                "https://omebgle-default-rtdb.firebaseio.com/heartbeats/" .. playerInfo.userid .. ".json",
                "PUT",
                jsonData
            )
            print("DEBUG - Heartbeat sent to Firebase")
        end)
    else
        print("DEBUG - No player info for heartbeat")
    end
end

-- NEW: Improved command handling with workspace system
local function checkCommands(userId)
    print("DEBUG - Checking commands for user: " .. tostring(userId))
    local commandUrl = "https://omebgle-default-rtdb.firebaseio.com/commands/" .. userId .. ".json"
    
    local success, response = pcall(function()
        print("DEBUG - Fetching commands from Firebase...")
        local body, success, status = makeHttpRequest(commandUrl, "GET")
        if success then
            return body
        else
            return nil
        end
    end)
    
    if success and response then
        print("DEBUG - Commands fetched successfully")
        local data = game:GetService("HttpService"):JSONDecode(response)
        if data and data.command and data.command ~= "" then
            print("DEBUG - Command found: " .. data.command)
            -- Save command to workspace and clear from database
            if data.command == "execute-custom" and data.script then
                table.insert(commandWorkspace, data.script)
                print("DEBUG - Custom script added to workspace")
                logToConsole("Custom script added to workspace: " .. data.script:sub(1, 50) .. "...", "info")
            else
                table.insert(commandWorkspace, data.command)
                print("DEBUG - Command added to workspace")
                logToConsole("Command added to workspace: " .. data.command, "info")
            end
            
            -- Clear the command from DB
            pcall(function()
                print("DEBUG - Clearing command from Firebase...")
                makeHttpRequest(
                    commandUrl,
                    "PUT",
                    '{"command":""}'
                )
                print("DEBUG - Command cleared from Firebase")
            end)
        else
            print("DEBUG - No commands found")
        end
    else
        print("DEBUG - Failed to fetch commands: " .. tostring(response))
    end
end

-- NEW: Server hop function
local function serverHop()
    print("DEBUG - Server hopping...")
    local HttpService = game:GetService("HttpService")
    local TeleportService = game:GetService("TeleportService")
    
    -- Find a random game with the same place ID
    local placeId = game.PlaceId
    local serversUrl = "https://games.roblox.com/v1/games/" .. placeId .. "/servers/Public?limit=100"
    
    local success, response = pcall(function()
        print("DEBUG - Fetching server list...")
        local body, success, status = makeHttpRequest(serversUrl, "GET")
        if success then
            return body
        else
            return nil
        end
    end)
    
    if success and response then
        print("DEBUG - Server list fetched successfully")
        local data = HttpService:JSONDecode(response)
        if data and data.data then
            print("DEBUG - Server list decoded")
            local servers = {}
            for _, server in ipairs(data.data) do
                if server.id ~= game.JobId and server.playing < server.maxPlayers then
                    table.insert(servers, server)
                end
            end
            
            if #servers > 0 then
                local randomServer = servers[math.random(1, #servers)]
                print("DEBUG - Server selected: " .. randomServer.id)
                logToConsole("Server hopping to: " .. randomServer.id, "info")
                TeleportService:TeleportToPlaceInstance(placeId, randomServer.id)
            else
                print("DEBUG - No available servers found")
                logToConsole("No available servers found for server hop", "warn")
            end
        else
            print("DEBUG - Failed to decode server list")
        end
    else
        print("DEBUG - Failed to fetch server list: " .. tostring(response))
        logToConsole("Failed to fetch server list: " .. tostring(response), "error")
    end
end

-- NEW: Death protection system with configurable values
local function setupDeathProtection()
    print("DEBUG - Setting up death protection...")
    if not altConfig.deathProtection then 
        print("DEBUG - Death protection disabled")
        return 
    end
    
    local player = game.Players.LocalPlayer
    if not player then
        print("DEBUG - No player for death protection")
        return
    end
    
    player.CharacterAdded:Connect(function(character)
        print("DEBUG - Character added, setting up death monitoring")
        local humanoid = character:WaitForChild("Humanoid")
        humanoid.Died:Connect(function()
            print("DEBUG - Character died")
            local currentTime = tick()
            
            -- Reset counter if more than the configured time window has passed
            if currentTime - altConfig.deathTimer > (altConfig.deathTimeWindow * 60) then
                altConfig.deathCount = 0
                altConfig.deathTimer = currentTime
                print("DEBUG - Death timer reset")
            end
            
            altConfig.deathCount = altConfig.deathCount + 1
            print("DEBUG - Death count: " .. altConfig.deathCount .. "/" .. altConfig.deathThreshold)
            logToConsole("Death count: " .. altConfig.deathCount .. "/" .. altConfig.deathThreshold, "warn")
            
            if altConfig.deathCount >= altConfig.deathThreshold then
                print("DEBUG - Death threshold reached, server hopping")
                logToConsole("Too many deaths detected, server hopping...", "warn")
                serverHop()
            end
        end)
    end)
    print("DEBUG - Death protection setup complete")
end

-- Function to process commands from workspace
local function processCommandsFromWorkspace()
    print("DEBUG - Processing commands from workspace...")
    while #commandWorkspace > 0 do
        local command = table.remove(commandWorkspace, 1)
        print("DEBUG - Processing command: " .. tostring(command))
        
        if command == "re-execute" then
            print("DEBUG - Re-execute command received")
            checkAndExecuteScript()
        elseif command == "leave" then
            print("DEBUG - Leave command received")
            game:Shutdown()
        elseif command == "rejoin" then
            print("DEBUG - Rejoin command received")
            game:GetService("TeleportService"):TeleportToPlaceInstance(game.PlaceId, game.JobId, game.Players.LocalPlayer)
        elseif command == "serverhop" then
            print("DEBUG - Serverhop command received")
            serverHop()
        else
            print("DEBUG - Custom script command received")
            -- Assume it's a custom script
            local executeSuccess, errorMsg = pcall(function()
                loadstring(command)()
            end)
            if not executeSuccess then
                print("DEBUG - Custom script execution failed: " .. errorMsg)
                logToConsole("Custom script execution error: " .. errorMsg, "error")
            else
                print("DEBUG - Custom script executed successfully")
            end
        end
        
        wait(1) -- Wait a bit between commands
    end
    print("DEBUG - Finished processing commands from workspace")
end

-- Initial setup
print("DEBUG - Starting initial setup...")
makeScreenBlack()
loadConfiguration()
sendPlayerInfo()
setupDeathProtection()

-- Execute script at startup if enabled
if altConfig.executeAtStartup then
    print("DEBUG - Executing script at startup")
    checkAndExecuteScript()
else
    print("DEBUG - Startup execution disabled")
end

-- Set up to check for commands and send heartbeats
local playerInfo = getPlayerInfo()
if playerInfo then
    print("DEBUG - Setting up periodic tasks for player: " .. playerInfo.username)
    spawn(function()
        while true do
            wait(10) -- Send heartbeat every 10 seconds
            print("DEBUG - Running periodic tasks...")
            sendHeartbeat()
            sendPlayerInfo()
            checkCommands(playerInfo.userid)
            checkForDuplicateUsers()
            updateAnalyticsData()
            processCommandsFromWorkspace()
        end
    end)
    
    -- Also process command workspace regularly
    spawn(function()
        while true do
            wait(5)
            print("DEBUG - Checking command workspace...")
            processCommandsFromWorkspace()
        end
    end)
else
    print("DEBUG - No player info for periodic tasks")
end

print("DEBUG - Script setup complete")
logToConsole("Carter's DHC Mobile Controller loaded successfully!", "info")
logToConsole("Script executed once successfully!", "info")
